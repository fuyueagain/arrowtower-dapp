# 🗺️ 箭塔村打卡 dApp - 完整业务流程图

## 📋 目录
1. [整体架构](#整体架构)
2. [用户登录和钱包连接流程](#用户登录和钱包连接流程)
3. [主页面打卡流程](#主页面打卡流程)
4. [扫码打卡流程](#扫码打卡流程)
5. [打卡验证和NFT铸造流程](#打卡验证和nft铸造流程)
6. [路线选择和进度管理流程](#路线选择和进度管理流程)

---

## 🏗️ 整体架构

```
┌──────────────────────────────────────────────────────────────────────┐
│                          箭塔村打卡 dApp 架构                          │
└──────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                             前端层 (Next.js 15 + React 19)               │
├─────────────────────────────────────────────────────────────────────────┤
│  • 首页 (/)                  - 登录和认证                                │
│  • 主页面 (/user)            - 地图浏览和打卡                            │
│  • 扫码页面 (/user/[poi])    - 二维码快速打卡                           │
│  • 管理页面 (/admin)         - 管理员审核                                │
│  • 路线页面 (/routes)        - 路线浏览                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↕ HTTP/REST API
┌─────────────────────────────────────────────────────────────────────────┐
│                             API 层 (Next.js API Routes)                  │
├─────────────────────────────────────────────────────────────────────────┤
│  • /api/auth/[...nextauth]   - NextAuth 认证                            │
│  • /api/route_list           - 路线列表                                  │
│  • /api/pois                 - 景点列表                                  │
│  • /api/checkins             - 打卡记录（GET/POST）                     │
│  • /api/admin/checkins       - 管理员审核                                │
│  • /api/metadata/[id]        - NFT 元数据                               │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↕ Prisma ORM
┌─────────────────────────────────────────────────────────────────────────┐
│                             数据层 (SQLite)                              │
├─────────────────────────────────────────────────────────────────────────┤
│  • User 表                   - 用户信息                                  │
│  • Route 表                  - 路线信息                                  │
│  • POI 表                    - 景点信息                                  │
│  • Checkin 表                - 打卡记录                                  │
│  • Voucher 表                - NFT 凭证                                  │
│  • CheckinPhoto 表           - 打卡照片                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↕ Web3
┌─────────────────────────────────────────────────────────────────────────┐
│                             区块链层 (Passet Hub Testnet)                │
├─────────────────────────────────────────────────────────────────────────┤
│  • ArrowTowerNFT 合约        - NFT 铸造和管理                           │
│  • ArrowTowerMinter 合约     - 游览完成和铸造逻辑                       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🔐 用户登录和钱包连接流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         1. 用户访问首页 (/)                              │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
                    ┌───────────────────────────────┐
                    │   检查 NextAuth Session       │
                    └───────────────────────────────┘
                                    ↓
                    ┌───────────────┴────────────────┐
                    │                                │
            ┌───────┴────────┐            ┌─────────┴────────┐
            │  未登录/未认证  │            │    已登录/已认证  │
            └───────┬────────┘            └─────────┬────────┘
                    ↓                                │
    ┌───────────────────────────────┐               ↓
    │  显示"开始探索"按钮            │    ┌──────────────────────────┐
    │  - 箭塔村介绍                  │    │  自动跳转到 /user 页面    │
    │  - 特色展示                    │    └──────────────────────────┘
    │  - 登录提示                    │
    └───────────────┬───────────────┘
                    ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  用户点击"开始探索"                                            │
    └───────────────┬───────────────────────────────────────────────┘
                    ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  NextAuth 登录流程                                             │
    │  - 创建或更新 session                                          │
    │  - 生成用户 ID                                                 │
    │  - 保存到数据库                                                │
    └───────────────┬───────────────────────────────────────────────┘
                    ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  跳转到 /user 页面                                             │
    └───────────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                         2. 连接钱包 (/user)                              │
└─────────────────────────────────────────────────────────────────────────┘
                    ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  页面加载后检查钱包连接状态 (useAccount)                       │
    └───────────────┬───────────────────────────────────────────────┘
                    ↓
            ┌───────┴────────┐
            │                │
    ┌───────┴────────┐  ┌────┴─────────┐
    │  未连接钱包     │  │  已连接钱包   │
    └───────┬────────┘  └────┬─────────┘
            ↓                │
    ┌──────────────────┐    │
    │ 显示"连接钱包"按钮│    │
    │ (Header 右上角)   │    │
    └──────┬───────────┘    │
            ↓                ↓
    ┌──────────────────────────────────────────────────┐
    │  用户点击"连接钱包"                               │
    │  - 弹出钱包选择器 (MetaMask, WalletConnect等)    │
    │  - 用户在钱包中确认连接                           │
    └──────┬───────────────────────────────────────────┘
            ↓
    ┌──────────────────────────────────────────────────┐
    │  钱包连接成功                                     │
    │  - 获取钱包地址 (0x...)                          │
    │  - 更新UI显示地址 (缩略形式: 0x1234...5678)      │
    │  - 启用打卡功能                                   │
    └──────────────────────────────────────────────────┘
                    ↓
    ┌──────────────────────────────────────────────────┐
    │  ✅ 用户已登录 + 钱包已连接                       │
    │  可以开始打卡流程                                 │
    └──────────────────────────────────────────────────┘
```

---

## 🗺️ 主页面打卡流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         3. 主页面打卡流程 (/user)                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  页面初始化                                                    │
    │  1. 获取路线列表: GET /api/route_list                         │
    │  2. 默认选择第一条路线 (route_1: 箭塔村创业探索)              │
    │  3. 获取该路线的POI: GET /api/pois?routeId=route_1           │
    │  4. 获取打卡记录: GET /api/checkins?routeId=route_1          │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  显示页面内容                                                  │
    │                                                                │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │  Header: [连接钱包] [0x1234...5678]                      │ │
    │  └──────────────────────────────────────────────────────────┘ │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │  路线选择器 (RouteSelector)                               │ │
    │  │  • 箭塔村创业探索 (3个景点, 已完成 0)  ← 当前选择         │ │
    │  │  • 箭塔村文化历史 (3个景点, 已完成 0)                     │ │
    │  └──────────────────────────────────────────────────────────┘ │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │  地图 (MapViewer)                                         │ │
    │  │  • SVG地图显示                                             │ │
    │  │  • 景点标记（圆点和文字）                                  │ │
    │  │  • 颜色编码:                                               │ │
    │  │    - 灰色: 其他景点                                        │ │
    │  │    - 蓝色: 当前路线景点                                    │ │
    │  │    - 绿色: 已完成景点                                      │ │
    │  │  • 支持缩放和平移                                          │ │
    │  └──────────────────────────────────────────────────────────┘ │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │  控制面板                                                  │ │
    │  │  • 钱包信息卡片                                            │ │
    │  │  • 路线进度卡片                                            │ │
    │  └──────────────────────────────────────────────────────────┘ │
    └───────────────────────────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  用户操作: 切换路线 (可选)                                     │
    │  - 点击路线选择器中的另一条路线                                │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  更新显示                                                      │
    │  1. 设置 selectedRoute = route_2                              │
    │  2. 重新获取POI: GET /api/pois?routeId=route_2               │
    │  3. 重新获取打卡记录: GET /api/checkins?routeId=route_2      │
    │  4. 更新地图颜色（蓝色标记新路线的景点）                       │
    │  5. 更新路线进度卡片                                           │
    └───────────────────────────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  用户操作: 点击地图上的景点文字                                │
    │  例如: 点击"箭塔村——猫鼻子餐厅"                               │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  触发 POI 点击事件                                             │
    │  1. 从 ID_TO_POI_MAP 获取 POI 编号 (9)                       │
    │  2. 从 pois 数组中找到对应的 POI 数据                         │
    │  3. 设置 selectedPOI = POI 9 的完整数据                       │
    │  4. 检查是否已打卡: completedPOIs.has(9)                     │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  弹出 POI 详情对话框 (POIDetailModal)                         │
    │                                                                │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │  ┌──────────┐  箭塔村——猫鼻子餐厅                        │ │
    │  │  │          │  景点 9 | location                         │ │
    │  │  │  图片    │                                             │ │
    │  │  │          │  猫鼻子餐厅是箭塔村的特色餐厅...           │ │
    │  │  └──────────┘                                             │ │
    │  │                                                            │ │
    │  │  [🎯 立即打卡]  或  [✓ 已打卡]                             │ │
    │  │  [取消]         或  [关闭]                                 │ │
    │  │                                                            │ │
    │  │  打卡说明:                                                 │ │
    │  │  • 需要连接钱包并签名确认                                  │ │
    │  │  • 确保已开启定位权限                                      │ │
    │  │  • 每个景点只能打卡一次                                    │ │
    │  └──────────────────────────────────────────────────────────┘ │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
            ┌───────────┴────────────┐
            │                        │
    ┌───────┴────────┐      ┌────────┴────────┐
    │  已打卡景点     │      │  未打卡景点      │
    └───────┬────────┘      └────────┬────────┘
            ↓                        ↓
    ┌──────────────────┐    ┌──────────────────────────────────────┐
    │ 显示"✓ 已打卡"    │    │  用户点击"🎯 立即打卡"               │
    │ (灰色, 不可点击)  │    └────────┬─────────────────────────────┘
    │                  │             ↓
    │ 用户只能点击"关闭"│    ┌───────────────────────────────────────┐
    └──────────────────┘    │  弹出签名确认对话框 (SignatureConfirm)│
                            │  • 显示景点名称                        │
                            │  • 显示打卡说明                        │
                            │  • [确认签名] [取消]                   │
                            └────────┬──────────────────────────────┘
                                     ↓
                            ┌────────────────────────────────────────┐
                            │  用户点击"确认签名"                    │
                            └────────┬───────────────────────────────┘
                                     ↓
                            ┌────────────────────────────────────────┐
                            │  开始签名流程                           │
                            │  1. 生成签名消息:                       │
                            │     "ArrowTower Checkin: poi=poi_9,    │
                            │      nonce=abc123, timestamp=..."      │
                            │  2. 调用 signMessageAsync()            │
                            │  3. 钱包弹出签名请求                    │
                            └────────┬───────────────────────────────┘
                                     ↓
                            ┌────────────────────────────────────────┐
                            │  用户在钱包中确认签名                   │
                            │  (MetaMask 弹窗)                       │
                            └────────┬───────────────────────────────┘
                                     ↓
                            ┌────────────────────────────────────────┐
                            │  签名成功，获取 signature              │
                            │  signature = "0x..."                   │
                            └────────┬───────────────────────────────┘
                                     ↓
                            ┌────────────────────────────────────────┐
                            │  提交打卡数据                           │
                            │  POST /api/checkins                    │
                            │  {                                     │
                            │    routeId: "route_1",                 │
                            │    poiId: "poi_9",                     │
                            │    walletAddress: "0x...",             │
                            │    signature: "0x...",                 │
                            │    message: "ArrowTower Checkin: ...", │
                            │    location: {                         │
                            │      latitude: 30.123567,              │
                            │      longitude: 103.456890,            │
                            │      accuracy: 12.5,                   │
                            │      timestamp: "2025-10-12..."        │
                            │    },                                  │
                            │    taskData: {                         │
                            │      type: "location",                 │
                            │      answer: "",                       │
                            │      photoUrl: ""                      │
                            │    },                                  │
                            │    deviceInfo: {                       │
                            │      fingerprint: "device_fp_...",     │
                            │      userAgent: "Mozilla/5.0..."       │
                            │    }                                   │
                            │  }                                     │
                            └────────┬───────────────────────────────┘
                                     ↓
                    ┌────────────────┴────────────────┐
                    │                                 │
          ┌─────────┴─────────┐          ┌──────────┴──────────┐
          │  打卡成功          │          │  打卡失败           │
          └─────────┬─────────┘          └──────────┬──────────┘
                    ↓                                ↓
    ┌────────────────────────────┐      ┌─────────────────────────┐
    │  显示成功结果               │      │  显示错误提示            │
    │  (CheckinProgress)         │      │  • 该景点已打卡          │
    │                            │      │  • 距离太远              │
    │  ✅ 打卡成功               │      │  • 签名验证失败          │
    │  打卡点: 猫鼻子餐厅 (第9站) │      │  • 其他错误              │
    │                            │      │                         │
    │  路线进度: 已完成 1/3      │      │  3秒后自动消失           │
    │  [进度条] ████░░░░░ 33%   │      └─────────────────────────┘
    │                            │
    │  ✓ 已打卡景点:             │
    │  [猫鼻子餐厅]              │
    │                            │
    │  📍 下一个打卡点           │
    │  箭塔村——吾乡乡村创业孵化器 │
    │                            │
    │  5秒后自动消失             │
    └────────────────────────────┘
                    ↓
    ┌────────────────────────────────────────────────┐
    │  更新页面状态                                   │
    │  1. 添加 poi_9 到 completedPOIs               │
    │  2. 更新地图颜色（poi_9 变为绿色）            │
    │  3. 更新路线进度卡片（已完成 1/3）            │
    │  4. 关闭 POI 详情对话框                       │
    └────────────────────────────────────────────────┘
                    ↓
    ┌────────────────────────────────────────────────┐
    │  用户继续打卡其他景点                           │
    │  重复上述流程，直到完成所有3个景点              │
    └────────────────────────────────────────────────┘
                    ↓
    ┌────────────────────────────────────────────────┐
    │  路线完成                                       │
    │  • 所有3个景点都已打卡                         │
    │  • 显示路线完成提示                             │
    │  • 后端自动触发NFT铸造流程                     │
    └────────────────────────────────────────────────┘
```

---

## 📱 扫码打卡流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    4. 扫码打卡流程 (/user/[poi])                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  场景设置                                                      │
    │  • 箭塔村在每个景点现场放置二维码标识牌                        │
    │  • 二维码内容: https://arrowtower.netlify.app/user/9         │
    │  • 用户到达景点9（猫鼻子餐厅）现场                            │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  用户扫描景点二维码                                            │
    │  (使用微信、支付宝、手机相机等)                               │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  浏览器自动打开                                                │
    │  URL: https://arrowtower.netlify.app/user/9                   │
    │  (本地测试: http://localhost:3000/user/9)                     │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  检查登录状态 (useSession)                                     │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
            ┌───────────┴────────────┐
            │                        │
    ┌───────┴────────┐      ┌────────┴────────┐
    │  未登录        │      │  已登录          │
    └───────┬────────┘      └────────┬────────┘
            ↓                        ↓
    ┌──────────────────┐    ┌───────────────────────────────────────┐
    │ 重定向到首页 (/) │    │  页面初始化                            │
    │ 完成登录后返回   │    │  1. 从 URL 获取 poi = "9"             │
    └──────────────────┘    │  2. 获取路线列表                       │
                            │  3. 获取第一条路线的POI列表            │
                            │  4. 匹配 poi=9，找到猫鼻子餐厅数据    │
                            └────────┬──────────────────────────────┘
                                     ↓
                            ┌────────────────────────────────────────┐
                            │  显示页面                               │
                            │                                        │
                            │  ┌────────────────────────────────────┐ │
                            │  │  Header: [连接钱包] [0x1234...]    │ │
                            │  └────────────────────────────────────┘ │
                            │  ┌────────────────────────────────────┐ │
                            │  │  📍 扫码打卡                        │ │
                            │  │  完成签名即可打卡                   │ │
                            │  └────────────────────────────────────┘ │
                            │  ┌────────────────────────────────────┐ │
                            │  │  POI 信息卡片                       │ │
                            │  │  ┌──────────┐  猫鼻子餐厅          │ │
                            │  │  │          │  景点 9 | location   │ │
                            │  │  │  图片    │                       │ │
                            │  │  │          │  餐厅描述...          │ │
                            │  │  └──────────┘                       │ │
                            │  │                                     │ │
                            │  │  [🎯 立即打卡]                      │ │
                            │  │  [取消]                             │ │
                            │  └────────────────────────────────────┘ │
                            └────────┬───────────────────────────────┘
                                     ↓
                            ┌────────────────────────────────────────┐
                            │  检查钱包连接状态                       │
                            └────────┬───────────────────────────────┘
                                     ↓
                    ┌────────────────┴────────────────┐
                    │                                 │
          ┌─────────┴─────────┐          ┌──────────┴──────────┐
          │  未连接钱包        │          │  已连接钱包          │
          └─────────┬─────────┘          └──────────┬──────────┘
                    ↓                                ↓
    ┌────────────────────────────┐      ┌────────────────────────┐
    │  显示提示                   │      │  "立即打卡"按钮可用    │
    │  ⚠️ 请先连接钱包           │      │  用户可以点击打卡       │
    │  点击右上角连接钱包按钮     │      └────────┬───────────────┘
    │                            │               ↓
    │  用户点击Header的连接钱包  │      ┌─────────────────────────┐
    │  ↓                         │      │  用户点击"🎯 立即打卡"  │
    │  连接成功后按钮可用         │      └────────┬────────────────┘
    └────────────────────────────┘               ↓
                    │                   ┌─────────────────────────────┐
                    │                   │  弹出签名确认对话框          │
                    │                   │  (SignatureConfirm)         │
                    │                   └────────┬────────────────────┘
                    │                            ↓
                    │                   ┌─────────────────────────────┐
                    │                   │  用户点击"确认签名"          │
                    │                   └────────┬────────────────────┘
                    │                            ↓
                    │                   ┌─────────────────────────────┐
                    └───────────────────→  签名流程 (同主页面流程)    │
                                        │  1. 生成签名消息             │
                                        │  2. signMessageAsync()      │
                                        │  3. 钱包确认                 │
                                        │  4. POST /api/checkins      │
                                        └────────┬────────────────────┘
                                                 ↓
                                ┌────────────────┴────────────────┐
                                │                                 │
                      ┌─────────┴─────────┐          ┌──────────┴──────────┐
                      │  打卡成功          │          │  打卡失败           │
                      └─────────┬─────────┘          └──────────┬──────────┘
                                ↓                                ↓
                ┌────────────────────────────┐      ┌─────────────────────────┐
                │  显示打卡结果               │      │  显示错误提示            │
                │  (CheckinProgress)         │      │  3秒后自动消失           │
                │                            │      └─────────────────────────┘
                │  ✅ 打卡成功               │
                │  打卡点: 猫鼻子餐厅 (第9站) │
                │                            │
                │  路线进度: 已完成 1/3      │
                │  [进度条] ████░░░░░ 33%   │
                │                            │
                │  ✓ 已打卡景点:             │
                │  [猫鼻子餐厅]              │
                │                            │
                │  📍 下一个打卡点           │
                │  箭塔村——吾乡乡村创业孵化器 │
                │                            │
                │  [返回地图]                │
                └────────┬───────────────────┘
                         ↓
                ┌─────────────────────────────┐
                │  用户选择                    │
                │  • 点击"返回地图"→ /user   │
                │  • 继续扫描下一个景点二维码  │
                └─────────────────────────────┘
```

---

## ⛓️ 打卡验证和NFT铸造流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│              5. 打卡验证和NFT铸造流程 (后端处理)                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  后端接收打卡请求                                              │
    │  POST /api/checkins                                           │
    │  {                                                             │
    │    routeId: "route_1",                                        │
    │    poiId: "poi_9",                                            │
    │    walletAddress: "0x64d13aae67528cf352198072b8d42029346027b7"│
    │    signature: "0x...",                                        │
    │    message: "ArrowTower Checkin: poi=poi_9, ...",            │
    │    location: { latitude, longitude, accuracy, timestamp },    │
    │    taskData: { type, answer, photoUrl },                      │
    │    deviceInfo: { fingerprint, userAgent }                     │
    │  }                                                             │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  步骤 1: 验证用户身份                                          │
    │  - 从数据库查询用户: prisma.user.findUnique()                 │
    │  - 如果用户不存在，创建新用户                                  │
    │  - 验证钱包地址格式                                            │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  步骤 2: 验证路线和POI                                         │
    │  - 查询路线是否存在且激活                                      │
    │  - 查询POI是否存在且属于该路线                                │
    │  - 验证POI order (9) 不是0（箭塔介绍不能打卡）               │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  步骤 3: 验证签名                                              │
    │  - 从 message 中提取 nonce 和 timestamp                       │
    │  - 使用 ethers.verifyMessage(message, signature)             │
    │  - 验证恢复的地址是否与 walletAddress 匹配                    │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
            ┌───────────┴────────────┐
            │                        │
    ┌───────┴────────┐      ┌────────┴────────┐
    │  签名验证失败   │      │  签名验证成功    │
    └───────┬────────┘      └────────┬────────┘
            ↓                        ↓
    ┌──────────────────┐    ┌───────────────────────────────────────┐
    │ 返回 400 错误    │    │  步骤 4: 检查重复打卡                  │
    │ "签名验证失败"   │    │  - 查询该用户在该POI的打卡记录         │
    └──────────────────┘    │  - prisma.checkin.findFirst()         │
                            └────────┬──────────────────────────────┘
                                     ↓
                    ┌────────────────┴────────────────┐
                    │                                 │
          ┌─────────┴─────────┐          ┌──────────┴──────────┐
          │  已存在打卡记录    │          │  首次打卡            │
          └─────────┬─────────┘          └──────────┬──────────┘
                    ↓                                ↓
    ┌────────────────────────────┐      ┌────────────────────────┐
    │  返回 400 错误              │      │  步骤 5: 创建打卡记录   │
    │  "该打卡点已打卡"          │      │  prisma.checkin.create()│
    └────────────────────────────┘      │  {                     │
                                        │    userId: "...",      │
                                        │    routeId: "route_1", │
                                        │    poiId: "poi_9",     │
                                        │    status: "approved", │
                                        │    signature: "0x...", │
                                        │    message: "...",     │
                                        │    location: {...},    │
                                        │    taskData: {...},    │
                                        │    deviceInfo: {...}   │
                                        │  }                     │
                                        └────────┬───────────────┘
                                                 ↓
                                        ┌────────────────────────┐
                                        │  步骤 6: 查询路线进度   │
                                        │  - 获取该路线的所有POI │
                                        │  - 获取用户在该路线的  │
                                        │    所有已批准打卡记录  │
                                        │  - 计算: 已完成/总数   │
                                        └────────┬───────────────┘
                                                 ↓
                                ┌────────────────┴────────────────┐
                                │                                 │
                      ┌─────────┴─────────┐          ┌──────────┴──────────┐
                      │  路线未完成        │          │  路线已完成          │
                      │  (1/3 或 2/3)     │          │  (3/3)              │
                      └─────────┬─────────┘          └──────────┬──────────┘
                                ↓                                ↓
                ┌────────────────────────────┐      ┌─────────────────────────┐
                │  返回打卡成功响应           │      │  步骤 7: 触发NFT铸造    │
                │  {                         │      │  - 创建 Voucher 凭证    │
                │    success: true,          │      │    (内存队列)           │
                │    data: {                 │      │  - 调用铸造处理器       │
                │      checkinId: "...",     │      │    (mint-processor)     │
                │      status: "approved",   │      └────────┬────────────────┘
                │      poi: {                │               ↓
                │        id: "poi_9",        │      ┌─────────────────────────┐
                │        name: "猫鼻子餐厅", │      │  NFT铸造流程            │
                │        order: 9            │      │  1. 获取 Owner 钱包     │
                │      },                    │      │     (私钥)              │
                │      routeProgress: {      │      │  2. 连接区块链          │
                │        completed: 1,       │      │     (Passet Hub)        │
                │        total: 3,           │      │  3. 调用合约方法        │
                │        nextPOI: {          │      │     completeTourAndMint │
                │          id: "poi_11",     │      │     (userAddress)       │
                │          name: "孵化器"    │      │  4. 等待交易确认        │
                │        },                  │      │  5. 获取 tokenId        │
                │        isRouteCompleted:   │      │  6. 创建 NFT 元数据     │
                │          false             │      │  7. 更新 Voucher 状态   │
                │      },                    │      │     (completed)         │
                │      nftStatus: {          │      └────────┬────────────────┘
                │        willMint: false,    │               ↓
                │        remainingPOIs: 2    │      ┌─────────────────────────┐
                │      }                     │      │  返回打卡成功响应        │
                │    }                       │      │  (包含NFT信息)          │
                │  }                         │      │  {                      │
                └────────────────────────────┘      │    ...(同左),           │
                                                    │    routeProgress: {     │
                                                    │      completed: 3,      │
                                                    │      total: 3,          │
                                                    │      nextPOI: null,     │
                                                    │      isRouteCompleted:  │
                                                    │        true             │
                                                    │    },                   │
                                                    │    nftStatus: {         │
                                                    │      willMint: true,    │
                                                    │      remainingPOIs: 0   │
                                                    │    }                    │
                                                    │  }                      │
                                                    └─────────────────────────┘
```

---

## 🎯 路线选择和进度管理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    6. 路线选择和进度管理流程                             │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  用户进入主页面 (/user)                                        │
    │  - 钱包已连接: 0x64d13aae67528cf352198072b8d42029346027b7     │
    │  - 已登录状态                                                  │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  加载路线数据                                                  │
    │  GET /api/route_list?page=1&limit=20&isActive=true           │
    │                                                                │
    │  返回:                                                         │
    │  {                                                             │
    │    success: true,                                             │
    │    data: {                                                    │
    │      routes: [                                                │
    │        {                                                      │
    │          id: "route_1",                                       │
    │          name: "箭塔村创业探索",                              │
    │          description: "箭塔村创业路径",                       │
    │          difficulty: "medium",                                │
    │          estimatedTime: 120,                                  │
    │          poiCount: 3,                                         │
    │          isActive: true                                       │
    │        },                                                     │
    │        {                                                      │
    │          id: "route_2",                                       │
    │          name: "箭塔村文化历史",                              │
    │          description: "箭塔村文化历史",                       │
    │          difficulty: "medium",                                │
    │          estimatedTime: 120,                                  │
    │          poiCount: 3,                                         │
    │          isActive: true                                       │
    │        }                                                      │
    │      ]                                                        │
    │    }                                                          │
    │  }                                                             │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  默认选择第一条路线                                            │
    │  setSelectedRoute("route_1")                                  │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  加载路线1的POI数据                                            │
    │  GET /api/pois?routeId=route_1                                │
    │                                                                │
    │  返回:                                                         │
    │  {                                                             │
    │    success: true,                                             │
    │    data: [                                                    │
    │      {                                                        │
    │        id: "poi_9",                                           │
    │        name: "箭塔村——猫鼻子餐厅",                            │
    │        order: 9,                                              │
    │        routeId: "route_1",                                    │
    │        taskType: "location"                                   │
    │      },                                                       │
    │      {                                                        │
    │        id: "poi_11",                                          │
    │        name: "箭塔村——吾乡乡村创业孵化器",                    │
    │        order: 11,                                             │
    │        routeId: "route_1",                                    │
    │        taskType: "location"                                   │
    │      },                                                       │
    │      {                                                        │
    │        id: "poi_22",                                          │
    │        name: "箭塔村——青年创客园地",                          │
    │        order: 22,                                             │
    │        routeId: "route_1",                                    │
    │        taskType: "location"                                   │
    │      }                                                        │
    │    ]                                                          │
    │  }                                                             │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  加载路线1的打卡记录                                           │
    │  GET /api/checkins?routeId=route_1&status=approved           │
    │                                                                │
    │  返回:                                                         │
    │  {                                                             │
    │    success: true,                                             │
    │    data: [                                                    │
    │      {                                                        │
    │        id: "checkin_123",                                     │
    │        poiId: "poi_9",                                        │
    │        poiName: "箭塔村——猫鼻子餐厅",                         │
    │        poiOrder: 9,                                           │
    │        status: "approved",                                    │
    │        user: {                                                │
    │          walletAddress: "0x64d13aae...6027b7"                │
    │        }                                                      │
    │      }                                                        │
    │    ]                                                          │
    │  }                                                             │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  过滤出当前用户的打卡记录                                      │
    │  completedPOIs = Set([ 9 ])  // 只有 poi_9 已完成            │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  更新地图颜色                                                  │
    │  - path3 (poi_9): 绿色 #10b981 (已完成)                      │
    │  - path4 (poi_11): 蓝色 #60a5fa (当前路线, 未完成)           │
    │  - path5 (poi_22): 蓝色 #60a5fa (当前路线, 未完成)           │
    │  - path1 (poi_21): 灰色 #9ca3af (其他路线)                   │
    │  - path2 (poi_2): 灰色 #9ca3af (其他路线)                    │
    │  - path6 (poi_20): 灰色 #9ca3af (其他路线)                   │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  显示路线选择器                                                │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │  选择探索路线                                             │ │
    │  │                                                           │ │
    │  │  ┌─────────────────────────────────────────────────────┐ │ │
    │  │  │ ✅ 箭塔村创业探索              ← 当前选择 (绿色边框)│ │ │
    │  │  │ 箭塔村创业路径                                      │ │ │
    │  │  │ 3 个景点 | 已完成 1                                 │ │ │
    │  │  └─────────────────────────────────────────────────────┘ │ │
    │  │                                                           │ │
    │  │  ┌─────────────────────────────────────────────────────┐ │ │
    │  │  │ 箭塔村文化历史                 (灰色边框)           │ │ │
    │  │  │ 箭塔村文化历史                                      │ │ │
    │  │  │ 3 个景点 | 已完成 0                                 │ │ │
    │  │  └─────────────────────────────────────────────────────┘ │ │
    │  └──────────────────────────────────────────────────────────┘ │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  用户点击"箭塔村文化历史"卡片                                 │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  切换路线                                                      │
    │  setSelectedRoute("route_2")                                  │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  加载路线2的POI数据                                            │
    │  GET /api/pois?routeId=route_2                                │
    │                                                                │
    │  返回: poi_2, poi_20, poi_21 (3个景点)                       │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  加载路线2的打卡记录                                           │
    │  GET /api/checkins?routeId=route_2&status=approved           │
    │                                                                │
    │  返回: 空数组 (用户未打卡任何路线2的景点)                     │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  更新状态                                                      │
    │  completedPOIs = Set([])  // 路线2无已完成景点                │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  更新地图颜色                                                  │
    │  - path1 (poi_21): 蓝色 #60a5fa (当前路线, 未完成)           │
    │  - path2 (poi_2): 蓝色 #60a5fa (当前路线, 未完成)            │
    │  - path6 (poi_20): 蓝色 #60a5fa (当前路线, 未完成)           │
    │  - path3 (poi_9): 灰色 #9ca3af (其他路线)                    │
    │  - path4 (poi_11): 灰色 #9ca3af (其他路线)                   │
    │  - path5 (poi_22): 灰色 #9ca3af (其他路线)                   │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  更新路线选择器显示                                            │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │  ┌─────────────────────────────────────────────────────┐ │ │
    │  │  │ 箭塔村创业探索                 (灰色边框)           │ │ │
    │  │  │ 箭塔村创业路径                                      │ │ │
    │  │  │ 3 个景点 | 已完成 1                                 │ │ │
    │  │  └─────────────────────────────────────────────────────┘ │ │
    │  │                                                           │ │
    │  │  ┌─────────────────────────────────────────────────────┐ │ │
    │  │  │ ✅ 箭塔村文化历史              ← 当前选择 (绿色边框)│ │ │
    │  │  │ 箭塔村文化历史                                      │ │ │
    │  │  │ 3 个景点 | 已完成 0                                 │ │ │
    │  │  └─────────────────────────────────────────────────────┘ │ │
    │  └──────────────────────────────────────────────────────────┘ │
    └───────────────────┬───────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  更新路线进度卡片                                              │
    │  ┌──────────────────────────────────────────────────────────┐ │
    │  │  🛤️ 当前路线                                             │ │
    │  │  箭塔村文化历史                                           │ │
    │  │                                                           │ │
    │  │  📊 打卡进度                                              │ │
    │  │  已完成: 0 / 3                                            │ │
    │  │  [进度条] ░░░░░░░░░░░░ 0%                                │ │
    │  │                                                           │ │
    │  │  ✓ 已打卡景点: (空)                                       │ │
    │  │                                                           │ │
    │  │  📍 下一个打卡点                                          │ │
    │  │  箭塔村——山花茶社                                         │ │
    │  └──────────────────────────────────────────────────────────┘ │
    └───────────────────────────────────────────────────────────────┘
                        ↓
    ┌───────────────────────────────────────────────────────────────┐
    │  用户可以开始打卡路线2的景点                                   │
    │  - 点击地图上的 poi_2, poi_20, 或 poi_21                    │
    │  - 或扫描对应景点的二维码                                      │
    └───────────────────────────────────────────────────────────────┘
```

---

## 📊 数据流总结

```
┌─────────────────────────────────────────────────────────────────────────┐
│                             完整数据流                                   │
└─────────────────────────────────────────────────────────────────────────┘

用户设备 (浏览器)
    ↕
Next.js 前端 (React + wagmi)
    ↕ HTTP API
Next.js API Routes
    ↕ Prisma ORM
SQLite 数据库
    ↕ 后台任务
NFT 铸造处理器
    ↕ Web3 (ethers.js)
Passet Hub 区块链
    ↕
ArrowTowerMinter 智能合约
    ↕
ArrowTowerNFT 智能合约

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

关键状态同步:
• 前端 completedPOIs Set ←→ 后端 Checkin 表
• 路线进度显示 ←→ 实时查询数据库
• 地图颜色 ←→ completedPOIs 和 routePOIs
• NFT 铸造状态 ←→ Voucher 表 status 字段
```

---

## ✅ 核心特性总结

1. **双打卡入口**: 地图浏览 + 扫码快速打卡
2. **路线系统**: 支持多条路线，独立进度管理
3. **实时同步**: 打卡后立即更新UI（颜色、进度、状态）
4. **Web3集成**: 钱包连接、签名验证、链上NFT铸造
5. **状态保护**: 防止重复打卡、签名验证、权限检查
6. **用户体验**: 临时提示消息、灰色已打卡按钮、进度可视化

---

**🎉 所有流程已完整实现并正常运行！**

